function $(t){return document.getElementById(t)}function fadeIn(t,e){t.style.opacity=0,t.style.display="block";let r=0;const s=setInterval(function(){(r+=50/(e||500))>=1&&(clearInterval(s),r=1),t.style.opacity=r},50)}function num(t){var e=parseInt(t);return e&&e.toString().length>4?e.toLocaleString("en-US").replace(/,/g," "):t}function isVisible(t){return!!(t.offsetWidth||t.offsetHeight||t.getClientRects().length)}function getOffset(t){const e=t.getBoundingClientRect();return{top:e.top+window.pageYOffset-document.documentElement.clientTop,left:e.left+window.pageXOffset-document.documentElement.clientLeft}}function slide(t){let e=t.offsetHeight/t.childElementCount,r=parseInt(t.style.top);t.style.top=t.style.top===`-${t.offsetHeight-e}px`?0:(isNaN(r)?-e:r-e)+"px"}class TextArea{constructor(t){this.el=t;let e=getOffset(t);this.top=e.top,this.left=e.left,this.width=t.offsetWidth,this.height=t.offsetHeight,this.contEditable="true"===t.contentEditable}getText(){if(this.contEditable)return this.el.innerText.trim();{let t=this.el.selectionStart,e=this.el.selectionEnd;return t===e?this.el.value.trim():this.el.value.slice(t,e)}}getContent(){return this.el[this.getProperty()]}replaceContent(t){if(this.contEditable){if(this.el.innerHTML.match(/<\/(div|p|span)>/)&&!confirm("Zamiana może spowodować utratę dodatkowych danych określających np. wygląd tekstu. Czy kontynuować?"))return;this.el.innerHTML=t.replace(/\n/g,"<br>")}else{let e=this.el.selectionStart,r=this.el.selectionEnd;this.el.value=e===r?t:this.el.value.substr(0,e)+app.corr.restoreSpaces(t)+this.el.value.substr(r)}}restoreContent(){this.el[this.getProperty()]=app.corr.txtRestore,app.corr.txtRestore=""}getProperty(){return this.contEditable?"innerHTML":"value"}}class CorrectionButton{constructor(){this.el=null,this.conf=Object.assign({type:"small",color:"#093",location:"bottom",inputs:!0},app.conf.btn)}show(){if(!this.el)return this.set(),this.show();let t="top"===this.conf.location?app.txtArea.top+5:app.txtArea.top+app.txtArea.height-35,e=window.innerWidth-(app.txtArea.left+app.txtArea.width);this.el.style.top=t.toFixed(2)+"px",this.el.style.right=e.toFixed(2)+"px",this.el.disabled=!1,fadeIn(this.el)}set(){document.body.insertAdjacentHTML("beforeend",'<button type="button" id="ik-do"><span id="ik-do-dsc">Autokorekta</span><span id="ik-do-alert"><span class="ik-i">ℹ</span>Wykryto prawdopodobne błędy w tekście.</span></button>'+app.cssLnk),this.el=$("ik-do"),this.el.style.setProperty("--bgcolor",this.conf.color),this.el.classList.toggle("ik-do-big","big"===this.conf.type),this.el.addEventListener("mouseleave",()=>{app.corrBtn.el.classList.add("ik-spin"),setTimeout(()=>app.corrBtn.el.classList.remove("ik-spin"),500)}),window.chrome&&this.el.classList.add("ik-chrome"+(window.innerWidth<641?"-mobile":""))}hide(){this.el&&!this.el.disabled&&isVisible(this.el)&&(app.panelEl&&isVisible(app.panelEl)||(this.el.style.display="none",app.stopCheckTxtErr()))}}class Correction{constructor(){this.txtOrigin="",this.txtRestore="",this.txtCorrected=null,this.conf=Object.assign({parags:0,profanity:0,gateway:!0},app.conf.corr)}static init(){app.corrBtn.el.disabled=!0,app.stopCheckTxtErr();let t=app.txtArea.getText().replace(/\n\n\n+/g,"\n\n");return app.corr&&app.corr.txtOrigin===t?app.showPanel():(app.corr=new Correction,app.corr.txtOrigin=t,t.trim().length<3?app.showPanel("Tekst jest zbyt krótki.",!0):void app.corr.callApi(t))}callApi(t){fetch(app.apiUrl,{method:"POST",body:this.getFetchFormData(t)}).then(t=>{if(t.ok)return t.json();throw Error(t.statusText)}).then(t=>{app.conf.prompt=!1,t.hasOwnProperty("txt_lmt")&&(app.txtLmt=t.txt_lmt),t.hasOwnProperty("chars_lmt")&&(app.charsLmt=t.chars_lmt),t.hasOwnProperty("calls_lmt")&&(app.callsLmt=t.calls_lmt),t.hasOwnProperty("error")?this.onError(t):this.onSuccess(t),t.hasOwnProperty("today_chars")&&($("ik-today-chars").textContent=num(t.today_chars)),t.hasOwnProperty("today_calls")&&($("ik-today-calls").textContent=t.today_calls)}).catch(t=>{console.log(t),this.onError({},null)})}getFetchFormData(t){const e=new FormData;return e.append("key","plugin"),e.append("text",t),e.append("info",1),this.conf.parags&&e.append("parags",this.conf.parags),this.conf.profanity&&e.append("profanity",this.conf.profanity),!this.conf.gateway&&e.append("gateway",0),e}onSuccess(t){this.txtCorrected=new TextCorrected(t),this.txtCorrected.addMarks(),app.showPanel(this.txtCorrected.txt,!1),app.setReportTxt()}onError(t){let e="";switch(t.error){case"TXT_LEN":e=`Tekst jest zbyt długi (${num(app.corr.txtOrigin.length)} na ${num(app.txtLmt)} dozwolonych znaków w jednej korekcie).`;break;case"CALLS_LMT_MIN":e="Osiągnięto limit korekt na minutę, spróbuj ponownie za chwilę.";break;case"CHARS_LMT_DAY":case"CALLS_LMT_DAY":e="Dzienny limit użycia pluginu został osiągnięty. Tekst możesz sprawdzić na "+app.lnk("?txt="+encodeURIComponent(this.txtOrigin),"iKorektor.pl");break;default:e="Coś poszło nie tak. Spróbuj ponownie za chwilę lub "+app.lnk("info#errors","dowiedz się więcej")}app.showPanel(e,!0),this.txtOrigin=""}restoreSpaces(t){return this.txtOrigin.match(/^\s*/)+t+this.txtOrigin.match(/\s*$/)}accept(){this.txtRestore=app.txtArea.getContent();let t=$("ik-txt-corr").innerHTML,e=app.corr.txtCorrected.stripMarksHTML(t);app.txtArea.replaceContent(Correction.decodeTags(e)),app.txtArea.el.focus(),app.panelEl.style.display="none"}static isInProgress(){return app.corrBtn.el&&app.corrBtn.el.disabled}static encodeTags(t){const e=document.createElement("p");return e.textContent=t,e.innerHTML}static decodeTags(t){const e={"&amp;":"&","&lt;":"<","&gt;":">","&quot;":'"',"&#039;":"'"};return t.replace(/&amp;|&lt;|&gt;|&quot;|&#039;/g,t=>e[t])}}class TextCorrected{constructor(t){this.txt=t.text,this.wordMarks=[],this.succs=t.hasOwnProperty("succs")?t.succs:[],this.suggs=t.hasOwnProperty("suggs")?t.suggs:[],this.fails=t.hasOwnProperty("fails")?t.fails:[]}addMarks(){this.tokenizeSuccs(),this.tokenizeSuggs(),this.tokenizeFails(),this.markTokensWithHTML()}tokenizeSuccs(){let t=0;for(let e=0;e<this.succs.length;e++){let r=this.succs[e],s="_"+this.wordMarks.length+"##",i=this.findSuggs(this.suggs,r.correction),o=r.hasOwnProperty("comments")?r.comments:null,n=new WordMarkSucc(r.error,o,s,r.correction,i);i?n.type+="-sugg":(i=this.findSuggs(this.fails,r.correction))&&(n.suggs=i,n.type+="-fail"),this.txt=this.txt.substr(0,r.position+t)+s+this.txt.substr(r.position+t+r.correction.length),this.wordMarks.push(n),t+=s.length-r.correction.length}}tokenizeSuggs(){const t=this;for(let e=0;e<this.suggs.length;e++){let r=this.suggs[e];this.txt=this.txt.replace(this.wordReg(r.word,"i"),function(e){let s=e[0].toLowerCase()===r.word[0].toLowerCase()?"":e[0],i=""===s?e:e.substr(1),o="_"+t.wordMarks.length+"##",n=r.suggs.map(t=>WordMark.markCharsDiff(r.word,t)),a=new WordMark(o,i,n,"sugg");return t.wordMarks.push(a),s+o})}}tokenizeFails(){const t=this;for(let e=0;e<this.fails.length;e++){let r=this.fails[e];this.txt=this.txt.replace(this.wordReg(r.error,"i"),function(e){let s=e[0].toLowerCase()===r.error[0].toLowerCase()?"":e[0],i=""===s?e:e.substr(1),o="_"+t.wordMarks.length+"##",n=r.hasOwnProperty("suggs")?r.suggs.map(t=>WordMark.markCharsDiff(r.error,t)):null,a=new WordMark(o,i,n,"fail");return n&&(a.type+="-sugg"),t.wordMarks.push(a),s+o})}}markTokensWithHTML(){this.txt=Correction.encodeTags(this.txt);for(let t=0;t<this.wordMarks.length;t++){let e=this.wordMarks[t],r="",s="",i=e.suggs?`<button class="ik-mark-btn ik-sugg">${e.suggs.join('</button><button class="ik-mark-btn ik-sugg">')}</button>`:"";e instanceof WordMarkSucc&&(null!==e.wordError&&(r='<button class="ik-mark-btn ik-mark-btn-rev">[cofnij korektę]</button>'),s=e.getCommentsHTML()),this.txt=this.txt.replace(e.id,`<span class="ik-mark"><span id="${e.id}" class="ik-corr ik-corr-${e.type}">${e.wordShow}</span><span class="ik-mark-menu">${s+i+r+WordMark.actionBtnsHTML()}</span></span>`)}}stripMarksHTML(t){return t.replace(/<\/?(?:span|mark).*?>|<ul>.+?<\/ul>|<button.+?<\/button>/g,"")}findSuggs(t,e){if(t){let r=t.findIndex(t=>(t.hasOwnProperty("word")?t.word:t.error)===e.toLowerCase());if(r>-1)return!!t[r].hasOwnProperty("suggs")&&t[r].suggs.map(t=>WordMark.markCharsDiff(e.toLowerCase(),t))}return null}findWordMark(t){return this.wordMarks.find(e=>e.id===t)}wordReg(t,e){return new RegExp(`(^|\\s|[.?!„'(/,:;<>=&#*_+-])(${t})(?=\\s|[.?!,…:;"”'()/<>=&#*_+-]|$)`,"g"+(e||""))}}class WordMark{constructor(t,e,r,s){this.id=t,this.wordCorr=e,this.wordShow=e,this.suggs=r,this.type=s,this.el=null}editStart(){let t=document.createRange(),e=window.getSelection();this.el.setAttribute("contenteditable",!0),t.setStart(this.el.childNodes[0],this.el.textContent.length),t.collapse(!0),e.removeAllRanges(),e.addRange(t)}editEnd(){let t=this.el.textContent,e=t===this.wordCorr,r=this.el.nextSibling;return this.wordShow=t,this.el.setAttribute("contenteditable",!1),this.el.classList.toggle("ik-corr-user",!e),this.suggsDisable(r,t),this.el.blur(),r.querySelector(".ik-mark-btn-rest").disabled=e,r.querySelector(".ik-mark-btn-edit").disabled=""===t,e}replaceWithSugg(t){let e=t.textContent,r=t.parentNode;this.wordCorr.match(/^[A-ZŻŹŁĆŚÓ]/)&&(e=this.wordCorr===this.wordCorr.toUpperCase()?e.toUpperCase():e[0].toUpperCase()+e.substr(1)),this.wordShow=e,this.el.textContent=e,this.el.classList.add("ik-corr-user"),this.suggsDisable(r),t.disabled=!0,r.querySelector(".ik-mark-btn-rest").disabled=!1,r.querySelector(".ik-mark-btn-edit").disabled=!1}restore(t){var e=t.parentNode;this.wordShow=this.wordCorr,this.el.textContent=this.wordCorr,this.el.classList.remove("ik-corr-user"),t.disabled=!0,this.suggsDisable(e),e.querySelector(".ik-mark-btn-edit").disabled=!1}suggsDisable(t,e=null){[].forEach.call(t.getElementsByClassName("ik-sugg"),t=>{t.disabled=e&&e.toLowerCase()===t.textContent})}static markCharsDiff(t,e){if(t&&e.trim().length>1){let r="";for(let s=0;s<e.length;s++){let[i,o]=s>0?[s-1,3]:[0,2],n=t.substr(i,o);" "!==e[s]&&-1===n.indexOf(e[s])?r+=`<span>${e[s]}</span>`:r+=e[s]}return r.replace(/<\/span><span>/g,"")}return e}static action(t){var e=t.parentNode.previousSibling,r=app.corr.txtCorrected.findWordMark(e.id);r.el=e,t.classList.contains("ik-mark-btn-rev")?r.reverse(t):t.classList.contains("ik-mark-btn-edit")?r.editStart():t.classList.contains("ik-mark-btn-rest")?r.restore(t):r.replaceWithSugg(t)}static actionBtnsHTML(){return'<button class="ik-mark-btn ik-mark-btn-rest" disabled>[przywróć]</button><button class="ik-mark-btn ik-mark-btn-edit">[edytuj]</button>'}}class WordMarkSucc extends WordMark{constructor(t,e,...r){super(...r),this.wordError=t,this.wordShow=WordMark.markCharsDiff(t,this.wordCorr),this.comments=e,this.type="succ"}editStart(){this.el.textContent=this.el.textContent.replace(/<\/?u>/g,""),super.editStart()}editEnd(){const t=super.editEnd();let e=this.el.nextSibling.querySelector(".ik-mark-btn-rev");e&&(e.disabled=!t),this.el.classList.toggle("ik-corr-rev",this.wordShow===this.wordError),t&&(this.wordShow=WordMark.markCharsDiff(this.wordError,this.wordCorr),this.el.innerHTML=this.wordShow)}replaceWithSugg(t){super.replaceWithSugg(t);let e=t.parentNode.querySelector(".ik-mark-btn-rev");e&&(e.disabled=!0),this.el.classList.remove("ik-corr-rev")}reverse(t){this.el.textContent=this.wordError,this.el.classList.add("ik-corr-rev"),this.el.classList.remove("ik-corr-user"),t.disabled=!0,t.parentNode.querySelector(".ik-mark-btn-rest").disabled=!1,t.parentNode.querySelector(".ik-mark-btn-edit").disabled=""===this.wordError}restore(t){super.restore(t),this.wordShow=WordMark.markCharsDiff(this.wordError,this.wordShow),this.el.innerHTML=this.wordShow,this.el.classList.remove("ik-corr-rev");let e=t.parentNode.querySelector(".ik-mark-btn-rev");e&&(e.disabled=!1)}getCommentsHTML(){if(this.comments){let[t]=this.comments;return this.comments[0]=t[0].toUpperCase()+t.substr(1),`<ul><li>${this.comments.join(",</li><li>")}.</li></ul>`.replace(/<li>(.+?); ?(https?.+?)(?=<|,)/g,'<li><a href="$2" target="_blank" rel="noopener" class="ik-i">ℹ</a>$1')}return""}}class App{constructor(){this.lnkUrl="https://ikorektor.pl/",this.apiUrl="https://api.ikorektor.pl",this.cssLnk='<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/ikorektor/plugin@3/css/style.css">',this.txtLmt=5e3,this.charsLmt=2e4,this.callsLmt=20,this.panelEl=null,this.txtArea=null,this.corr=null,this.corrBtn=null,this.checkTxtErrId=null,this.conf={btn:null,corr:null,parags:0,profanity:0,gateway:!0,txtbg:!0,prompt:!1,always:!1,version:null,csshash:null}}init(t){"object"==typeof iKorektorConf&&(this.conf=Object.assign(this.conf,iKorektorConf)),this.conf.version&&this.conf.csshash&&(this.cssLnk=this.cssLnk.replace("@3","@"+this.conf.version).replace(">",` integrity="${this.conf.csshash}" crossorigin="anonymous">`)),(t||this.conf.always)&&(this.corrBtn=new CorrectionButton,this.checkActiveEl(),document.addEventListener("click",this.onClick))}onClick(t){let e=t.target;if(e)if(app.isTxtArea(e)&&!Correction.isInProgress())app.ready(e);else if(app.isTxtArea(e.parentNode)&&!Correction.isInProgress())app.ready(e.parentNode);else if(e.classList.contains("ik-mark-btn"))WordMark.action(e);else if(e.parentNode.classList.contains("ik-mark-btn"))WordMark.action(e.parentNode);else if("ik-lmt"===e.parentNode.id)slide(e.parentNode);else if("ik-lmt"===e.parentNode.parentNode.id)slide(e.parentNode.parentNode);else if(app.conf.prompt&&"submit"===e.type)app.onSubmit(t);else switch(e.id){case"ik-do":case"ik-do-dsc":Correction.init();break;case"ik-do-alert":app.stopCheckTxtErr(),app.txtArea.el.focus();break;case"ik-accept":app.corr.accept();break;case"ik-cancel":app.panelEl.style.display="none",app.txtArea?app.txtArea.el.focus():app.corrBtn.el.style.display="none";break;default:app.corrBtn.hide()}}onKeyDown(t){let e=t.target;13===t.keyCode&&e&&e.classList.contains("ik-corr")?app.corr.txtCorrected.findWordMark(e.id).editEnd():90===t.keyCode&&t.ctrlKey&&app.corr.txtRestore&&(t.preventDefault(),app.txtArea.restoreContent())}onSubmit(t){let e=document.querySelectorAll("textarea, [contenteditable]");if(e){let r=null;for(let t of e){let e="textarea"===t.tagName.toLowerCase()?t.value:t.innerText;!r&&e.length>2&&(r=t)}r&&(app.conf.prompt=!1,confirm("Czy chcesz sprawdzić błędy w tekście przed wysłaniem?")&&(t.preventDefault(),r.scrollIntoView({behavior:"smooth"}),app.ready(r),Correction.init()))}}checkActiveEl(){let t=document.activeElement;t&&this.isTxtArea(t)&&this.ready(t)}startCheckTxtErr(){this.stopCheckTxtErr(),this.checkTxtErrId=setInterval(()=>{let t=app.txtArea.getContent();(t.match(/(^|\. )[a-zćłóśżź]/)||t.length>30&&!t.match(/[ąęćłńóśżź]/))&&(fadeIn($("ik-do-alert")),this.stopCheckTxtErr(!1))},5e3)}stopCheckTxtErr(t=!0){clearInterval(this.checkTxtErrId);let e=()=>{$("ik-do-alert").style.display="none"};t?e():setTimeout(e,9999)}isTxtArea(t){let e=t.tagName.toLowerCase();return!!("textarea"===e||"true"===t.contentEditable||this.corrBtn.conf.inputs&&"input"===e&&"text"===t.type)}ready(t){this.corr&&t!==this.txtArea.el&&(this.corr.txtRestore=""),this.panelEl&&(this.panelEl.style.display="none"),this.txtArea=new TextArea(t),this.corrBtn.show(),this.startCheckTxtErr()}showPanel(t,e){if(!this.panelEl)return this.setPanel(),this.showPanel(t,e);app.corrBtn.el.disabled=!1,this.panelEl.style.top=parseInt(app.corrBtn.el.style.top,10)+app.corrBtn.el.offsetHeight+10+"px",this.panelEl.style.right=app.corrBtn.el.style.right;const r=$("ik-txt-corr");if(t){r.innerHTML=t,r.classList.toggle("ik-corr-err",e),$("ik-accept").disabled=e,$("ik-txt-len").textContent=app.corr?num(app.corr.txtOrigin.length):0;let s=t.match(/-succ/g);$("ik-corr-cnt").textContent=s?s.length:0}fadeIn(this.panelEl)}setPanel(){document.body.insertAdjacentHTML("beforeend",`<div id="ik-panel">\n        <div id="ik-txt-area">\n        <div id="ik-txt-corr"></div>\n        <div id="ik-lmt-wnd">\n        <ul id="ik-lmt">\n        <li>Poprawionych błędów: <span id="ik-corr-cnt"></span></li>\n        <li>Długość tekstu źródłowego: <span id="ik-txt-len"></span> / ${num(this.txtLmt)}</li>\n        <li>Sprawdzonych znaków dzisiaj: <span id="ik-today-chars">0</span> / ${num(this.charsLmt)}</li>\n        <li>Wykonanych korekt dzisiaj: <span id="ik-today-calls">0</span> / ${this.callsLmt}</li>\n        </ul>\n        </div>\n        <a href="https://ikorektor.pl" target="_blank" rel="noopener" id="ik-link">iKorektor</a>\n        <div class="ik-i">ℹ\n        <ul id="ik-menu">\n        <li><a href="https://ikorektor.pl/info" target="_blank" rel="noopener">Informacje o korekcie</a></li>\n        <li><a href="https://ikorektor.pl/pluginy" target="_blank" rel="noopener">Informacje o wtyczce</a></li>\n        <li><a href="https://ikorektor.pl/kontakt?report" target="_blank" rel="noopener" id="ik-report">Zgłoś błąd korekty</a></li>\n        </ul>\n        </div>\n        </div>\n        <button type="button" id="ik-cancel" class="ik-btn">Anuluj</button>\n        <button type="button" id="ik-accept" class="ik-btn">Zamień</button>\n        </div>`),$("ik-txt-area").classList.toggle("ik-txt-bg",this.conf.txtbg),this.panelEl=$("ik-panel"),window.chrome&&this.panelEl.classList.add("ik-chrome");let t=window.innerWidth<641?"ik-mobile":window.chrome?"ik-chrome":null;t&&($("ik-accept").classList.add(t),$("ik-cancel").classList.add(t)),document.addEventListener("keydown",app.onKeyDown),document.addEventListener("focusout",t=>t.target&&t.target.classList.contains("ik-corr")&&app.corr.txtCorrected.findWordMark(t.target.id).editEnd())}setReportTxt(){const t=$("ik-report");t.href=t.href.replace(/report.*/,"report="+encodeURIComponent(this.corr.txtOrigin))}lnk(t,e){return`<a href="${this.lnkUrl+t}" target="_blank" rel="noopener">${e}</a>`}}var app=new App;app.init(document.getElementsByTagName("textarea").length||document.querySelector("input[type=text]"));
