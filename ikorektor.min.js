var iKorektor=new function(){var t,e,r=!1,i=!1,n={parags:0,profanity:0,gateway:!0,location:"bottom"},a=document.getElementById("ik-conf");a&&(n.parags=a.getAttribute("data-parags"),n.profanity=a.getAttribute("data-profanity"),n.gateway="true"===a.getAttribute("data-gateway"),n.location=a.getAttribute("data-location")),this.init=function(){document.body.insertAdjacentHTML("beforeend",'<button type="button" id="ik-do" title="Sprawdź błędy w tekście"><p></p></button>\n<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/ikorektor/plugin@1.1.0/css/style.min.css">'),document.addEventListener("focusin",t=>{if(t.target){var e=t.target.tagName.toLowerCase();("textarea"===e||"input"===e&&"text"===t.target.getAttribute("type"))&&(o(),r||(document.addEventListener("mousedown",t=>{t.target&&"ik-do"===t.target.id&&s(t.target)}),r=!0))}})};var o=function(){t=document.activeElement;var e=document.getElementById("ik-do"),r=document.getElementById("ik-inf");e.style.display="block";var i=S(t),a="top"===n.location?i.top+5:i.top+t.offsetHeight-e.offsetHeight-5,o=window.innerWidth-(i.left+t.offsetWidth);e.style.top=a.toFixed(2)+"px",e.style.right=o.toFixed(2)+"px",e.disabled=!1,r&&(r.style.display="none")},s=function(t){var e=d();e.length<3?u("Tekst jest zbyt krótki.",!0):(t.disabled=!0,t.querySelector("p").classList.add("ik-spin"),c(e))},c=function(t){fetch("https://api.ikorektor.pl",{method:"POST",body:l(t)}).then(t=>{if(t.ok)return t.json();throw Error(t.statusText)}).then(r=>{if(r.hasOwnProperty("error"))u(k(r,t.length),!0);else{e=t;var i=document.createElement("p");i.textContent=r.text,r.text=i.innerHTML,u(y(r),!1)}}).catch(t=>{console.log(t),u("Coś poszło nie tak. Spróbuj ponownie za chwilę.",!0)})},l=function(t){var e=new FormData;return e.append("key","O"),e.append("text",t),e.append("app","plugin"),n.parags&&e.append("parags",n.parags),n.profanity&&e.append("profanity",n.profanity),n.gateway||e.append("gateway",n.gateway),e},d=function(){var e=t.selectionStart,r=t.selectionEnd;return e===r?t.value.trim():t.value.slice(e,r)},u=function(t,e){var r=document.getElementById("ik-inf");r||(r=g());var i=document.getElementById("ik-do"),n=r.querySelector("div"),a=r.querySelector("#ik-accept"),o=S(i);i.disabled=!e,i.querySelector("p").classList.remove("ik-spin"),r.style.top=o.top+i.offsetHeight+9+"px",r.style.right=i.ownerDocument.defaultView.getComputedStyle(i,null).right,r.style.display="block",n.innerHTML=t,n.classList.toggle("ik-corr-err",e),a.disabled=e,a.classList.toggle("ik-btn-disabled",e),e||f()},g=function(){return document.body.insertAdjacentHTML("beforeend",'<div id="ik-inf">\n<div></div>\n<button type="button" id="ik-accept">Akceptuj i zamień</button>\n<button type="button" id="ik-cancel">Anuluj</button>\n<p><a href="https://ikorektor.pl/pluginy" target="_blank">Plugin autokorekty © iKorektor</a> • \n<a href="https://ikorektor.pl/kontakt?report" id="ik-report">Zgłoś błąd korekty</a> • \n<a href="https://ikorektor.pl/info" target="_blank">Objaśnienia</a></p>\n<ul id="ik-colors"></ul>\n</div>'),i||(document.addEventListener("click",r=>{r.target&&("li"===r.target.tagName.toLowerCase()&&r.target.parentNode.parentNode.classList.contains("ik-bgword")?b(r.target):"ik-accept"===r.target.id?m():"ik-cancel"===r.target.id?t.focus():"ik-report"===r.target.id&&(r.preventDefault(),window.open(r.target.href+"="+(e||""))))}),document.addEventListener("keydown",r=>{13===r.keyCode&&r.target&&r.target.classList.contains("ik-word-corr-origin")?v(r.target):90===r.keyCode&&r.ctrlKey&&e&&(t.value=e,e=null)}),document.addEventListener("focusout",t=>{t.target&&t.target.classList.contains("ik-word-corr-origin")&&v(t.target)}),i=!0),document.getElementById("ik-inf")},p=function(t){return e.match(/^\s*/)+t+e.match(/\s*$/)},k=function(t,e){switch(t.error){case"TXT_LEN":return`Tekst jest zbyt długi (${e} na ${t.txt_limit} dozwolonych znaków w jednej korekcie).`;case"CHARS_LMT":return`Możesz sprawdzić dzisiaj jeszcze ${t.chars_left} znaków, tekst ma ${e} znaków.`;case"CALLS_LMT":return"Osiągnięto limit korekt na minutę. Spróbuj ponownie za chwilę.";case"CALLS_LMT_SITE":return"Osiągnięto dobowy limit użycia pluginu."}return"Wystąpił nieoczekiwany błąd."},f=function(){[].forEach.call(document.getElementsByClassName("ik-bgword"),t=>{t.classList.contains("ik-char-succ")||t.querySelector("ul").insertAdjacentHTML("beforeend",'<li class="ik-act-user ik-act-edit">[edytuj]</li><li class="ik-act-user ik-act-restore ik-hidden">[przywróć]</li>')})},y=function(t){var r=t.text,i=r.match(/[a-zA-ZŻŹŁŚĆÓąęćłóśńżź]{2,}/g),n=r.match(/.{4}[,.)”–?]|[(„].{4}/g),a=[],o=null;if(n)for(var s=0;s<n.length;s++)-1===e.indexOf(n[s])&&-1===e.indexOf(L(n[s].toLowerCase()))&&(r=r.replace(n[s],n[s].replace(/([,.()„”–?])/g,'<span class="ik-bgword ik-corr-succ ik-char-succ">$1</span>')));if(t.hasOwnProperty("sugg"))for(s=0;s<t.sugg.length;s++){var c=t.sugg[s];console.log(c);var l=c.length-1,d=(g=c[l]).toLowerCase(),u="";(c=c.slice(0,l)).indexOf(d)<0&&c.indexOf(g.substr(0,1).toUpperCase()+d.substr(1))<0?u="2":c=h(c,d),r=r.replace(w(g,"i"),'$1<span class="ik-bgword ik-corr-sugg'+u+'"><span data-word-corr-origin="$2" class="ik-word-corr-origin">$2</span><ul><li>'+c.reverse().join("</li><li>")+"</li></ul></span>"),a.push(g)}if(i)for(s=0;s<i.length;s++){var g=i[s];if(o=w(g),!e.match(o)){r=r.replace(o,'$1<span class="ik-bgword ik-corr-succ"><span data-word-corr-origin="$2" class="ik-word-corr-origin">$2</span><ul></ul></span>');var p=new RegExp('ik-corr-sugg(2?)(?="><span data-word-corr-origin="'+g+")","g");r=r.replace(p,"ik-corr-sugg$1-succ")}}if(t.hasOwnProperty("succ"))for(s=0;s<t.succ.length;s++){var k=t.succ[s][0],f=t.succ[s][1];a.indexOf(f)>=0?(o=new RegExp('ik-corr-sugg(?="><span data-word-corr-origin="'+k+")","g"),r=r.replace(o,"ik-corr-sugg-succ")):(o=new RegExp(">"+k+"</span><ul></ul>","g"),r=r.replace(o,'data-word-origin="'+f+'">'+k+'</span><ul><li class="ik-act-user ik-act-revert">[cofnij]</li></ul>'))}if(t.hasOwnProperty("fail"))for(s=0;s<t.fail.length;s++)r=r.replace(w(t.fail[s]),'$1<span class="ik-bgword ik-corr-fail"><span data-word-corr-origin="$2" class="ik-word-corr-origin">$2</span><ul></ul></span>');return r},w=function(t,e){return new RegExp("(\\s|[„(/,:;]|-|^)("+t+')(?=\\s|[.?!,…:;"”()/<]|-|$)',"g"+(e||""))},m=function(){var e=document.getElementById("ik-inf").querySelector("div").innerHTML,r=x(e);!function(e){var r=t.selectionStart,i=t.selectionEnd;t.value=r===i?e:t.value.substr(0,r)+p(e)+t.value.substr(i)}(E(r)),t.focus()},h=function(t,e){if(t.splice(t.indexOf(e),1),e.indexOf("rz")>-1){var r=t.indexOf(e.replace("rz","z"));r>-1&&t.splice(r,1)}return t},v=function(t){var e=t.nextElementSibling,r=t.textContent,i=r===t.getAttribute("data-word-origin"),n=r===t.getAttribute("data-word-corr-origin");t.setAttribute("contenteditable","false"),t.classList.toggle("ik-corr-user",!n&&!i),t.classList.toggle("ik-corr-revert",i),e.querySelector(".ik-act-restore").classList.toggle("ik-hidden",n),e.querySelector(".ik-act-edit").classList.toggle("ik-hidden",""===r);var a=e.querySelector(".ik-act-revert");a&&a.classList.toggle("ik-hidden",i)},b=function(t){var e=t.parentNode.parentNode.querySelector(".ik-word-corr-origin");t.classList.contains("ik-act-revert")?function(t,e){t.textContent=t.getAttribute("data-word-origin"),t.classList.add("ik-corr-revert"),t.classList.remove("ik-corr-user"),e.style.display="none",e.parentNode.querySelector(".ik-act-restore").classList.remove("ik-hidden")}(e,t):t.classList.contains("ik-act-edit")?function(t){var e=document.createRange(),r=window.getSelection();t.setAttribute("contenteditable","true"),e.setStart(t.childNodes[0],t.textContent.length),e.collapse(!0),r.removeAllRanges(),r.addRange(e)}(e):t.classList.contains("ik-act-restore")?function(t,e){var r=t.getAttribute("data-word-corr-origin");t.textContent=r,t.classList.remove("ik-corr-user","ik-corr-revert"),e.classList.add("ik-hidden"),e.parentNode.querySelector(".ik-act-edit").style.display="block";var i=e.parentNode.querySelector(".ik-act-revert");i&&(i.style.display="block")}(e,t):function(t,e){var r=e.textContent;t.textContent.match(/^[A-ZŻŹŁĆŚÓ]/)&&(r=r.charAt(0).toUpperCase()+r.substr(1)),t.textContent=r,t.classList.toggle("ik-corr-user",r!==t.getAttribute("data-word-corr-origin")),e.parentNode.querySelector(".ik-act-restore").classList.remove("ik-hidden")}(e,t)},L=function(t){return t.replace("ó","o").replace("ł","l").replace("ą","a").replace("ę","e").replace("ś","s").replace("ń","n").replace("ć","c").replace("ż","z").replace("ź","z")},x=function(t){return t.replace(/<ul>.*?<\/ul>|<\/?span.*?>/g,"")},E=function(t){var e={"&amp;":"&","&lt;":"<","&gt;":">","&quot;":'"',"&#039;":"'"};return t.replace(/&amp;|&lt;|&gt;|&quot;|&#039;/g,t=>e[t])},S=function(t){const e=t.getBoundingClientRect();return{top:e.top+window.pageYOffset-document.documentElement.clientTop,left:e.left+window.pageXOffset-document.documentElement.clientLeft}}};iKorektor.init();
