var iKorektor=new function(){const e="https://ikorektor.pl/";var t,n,i,r,a,o,s,c='<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/ikorektor/plugin@2/css/style.min.css">',l={type:"small",location:"bottom",color:"#093",inputs:!0,txtbg:!0,prompt:!1,parags:0,profanity:0,gateway:!0,version:null,csshash:null,listen:!1};this.init=function(e){"object"==typeof iKorektorConf&&(l=Object.assign(l,iKorektorConf)),l.version&&l.csshash&&(c=c.replace("@2","@"+l.version).replace(">",` integrity="${l.csshash}" crossorigin="anonymous">`)),(e||l.listen)&&document.addEventListener("click",d),t=null,i=null,u()};var u=function(){var e=document.activeElement;e&&g(e)&&f()},d=function(r){var a=r.target;if(a)if(t&&t.disabled||!g(a))if("li"===a.tagName.toLowerCase()&&a.className.indexOf("ik-")>-1&&!a.classList.contains("ik-dis"))_(a);else if("ik-lmt"===a.parentNode.id)p(a.parentNode);else if(l.prompt&&"submit"===a.type)k(r);else switch(a.id){case"ik-do":m();break;case"ik-accept":Z(a.parentNode);break;case"ik-cancel":a.parentNode.style.display="none",n.focus();break;case"ik-about":window.open(e+"pluginy");break;case"ik-report":window.open(e+"kontakt?report="+(i?encodeURIComponent(i):""));break;case"ik-target":r.preventDefault(),window.open(e+"?txt="+encodeURIComponent(n.value));break;default:y()}else f()},p=function(e){var t=e.offsetHeight/e.childElementCount,n=parseInt(e.style.top);e.style.top=e.style.top===`-${e.offsetHeight-t}px`?0:(isNaN(n)?-t:n-t)+"px"},k=function(e){var t=document.getElementsByTagName("textarea");if(t){n=null;for(var i=0;i<t.length;i++)if(t[i].value.length>2){n=t[i];break}n&&(l.prompt=!1,confirm("Czy chcesz wykonać autokorektę tekstu przed wysłaniem?")&&(e.preventDefault(),f(),m(),n.scrollIntoView({behavior:"smooth"})))}},g=function(e){var t=e.tagName.toLowerCase();return!!("textarea"===t||l.inputs&&"input"===t&&"text"===e.type||"true"===e.contentEditable)&&(n!==e&&(r=null),n=e,!0)},f=function(){if(!t)return v();t.style.display="block";var e=te(n),i="top"===l.location?e.top+5:e.top+n.offsetHeight-35,r=window.innerWidth-(e.left+n.offsetWidth);t.style.top=i.toFixed(2)+"px",t.style.right=r.toFixed(2)+"px",t.disabled=!1;var a=ae("ik-inf");a&&(a.style.display="none")},v=function(){document.body.insertAdjacentHTML("beforeend",Q("","ik-do")+c),(t=ae("ik-do")).classList.toggle("sml","small"===l.type),t.style.setProperty("background-color",l.color),t.style.setProperty("--bgcolor",l.color),f()},y=function(){if(t&&!t.disabled&&ie(t)){var e=ae("ik-inf");e&&ie(e)||(t.style.display="none")}},m=function(){t.disabled=!0,a=window.getSelection();var e=L();return i===e?C():(i=e,s=0,e.trim().length<3?C("Tekst jest zbyt krótki.",!0):void h())},h=function(){fetch("https://api.ikorektor.pl",{method:"POST",body:x(),credentials:"include"}).then(e=>{if(e.ok)return e.json();throw Error(e.statusText)}).then(e=>{e.hasOwnProperty("error")?w(e):b(e),e.hasOwnProperty("today_chars_used")&&(ae("ik-today-chars-used").textContent=e.today_chars_used)}).catch(e=>{console.log(e),w({},null)})},b=function(e){r="true"===n.contentEditable?n.innerHTML:n.value,l.prompt=!1;var t=document.createElement("p");t.textContent=e.text,e.text=t.innerHTML,C(T(e),!1)},w=function(e){var t="";switch(e.error){case"TXT_LEN":t=`Tekst jest zbyt długi (${i.length} na ${e.txt_limit} dozwolonych znaków w jednej korekcie).`;break;case"CHARS_LMT":t=`Pozostało Ci ${e.chars_left} ${ne(e.chars_left)} z dobowego limitu, tekst ma ${i.length} ${ne(i.length)}. Tekst możesz poprawić w serwisie `+ee("","iKorektor.pl","ik-target");break;case"CALLS_LMT":t="Osiągnięto limit korekt na minutę. Spróbuj ponownie za chwilę.";break;case"SITE_LMT":t="Dobowy limit użycia pluginu na stronie został osiągnięty. Tekst możesz poprawić w serwisie "+ee("","iKorektor.pl","ik-target");break;default:t="Coś poszło nie tak. Spróbuj ponownie za chwilę lub "+ee("info#errors","dowiedz się więcej")}C(t,!0),i=null},x=function(){var e=new FormData;return e.append("key","plugin"),e.append("text",i),l.parags&&e.append("parags",l.parags),l.profanity&&e.append("profanity",l.profanity),l.gateway||e.append("gateway",0),e},L=function(){var e;if("true"===n.contentEditable)e=$();else{var t=n.selectionStart,i=n.selectionEnd;e=t===i?n.value.trim():n.value.slice(t,i)}return e.replace(/\n\n\n+/g,"\n\n")},$=function(){return a.isCollapsed||a.focusNode.parentNode!==n?(a=null,n.innerText.trim()):(o=a.getRangeAt(0),a.toString())},C=function(e,n){var r=ae("ik-inf");if(!r)return z(e,n);var a=ae("ik-txt");t.disabled=!1,r.style.top=parseInt(t.style.top,10)+t.offsetHeight+9+"px",r.style.right=t.style.right,r.style.display="block",e&&(a.innerHTML=e,a.classList.toggle("ik-corr-err",n),ae("ik-accept").disabled=n,ae("ik-txt-len").textContent=i.length,ae("ik-corr-cnt").textContent=s),re(a)},z=function(e,t){document.body.insertAdjacentHTML("beforeend",E()),ae("ik-txt-area").classList.toggle("ik-nobg",!l.txtbg),S(),C(e,t)},E=function(){return`<div id="ik-inf"><div id="ik-txt-area"><div id="ik-txt"></div>\n<div id="ik-lmt-wnd"><ul id="ik-lmt">\n<li>Poprawionych błędów: <span id="ik-corr-cnt">0</span></li>\n<li>Długość tekstu źródłowego: <span id="ik-txt-len">0</span></li>\n<li>Sprawdzonych znaków dzisiaj: <span id="ik-today-chars-used">0</span></li>\n</ul></div>${ee("info","ℹ","ik-i")}</div>\n${Q("Anuluj","ik-cancel")+Q("Akceptuj i zamień","ik-accept")}\n<ul id="ik-menu"><li id="ik-about">Plugin © iKorektor</li>•<li id="ik-report">Zgłoś błąd korekty</li></ul>\n</div>`},S=function(){document.addEventListener("keydown",e=>{var t=e.target;13===e.keyCode&&t&&t.classList.contains("ik-corr")?K(t):90===e.keyCode&&e.ctrlKey&&r&&(e.preventDefault(),"true"===n.contentEditable?n.innerHTML=r:n.value=r,r=null)}),document.addEventListener("focusout",e=>{var t=e.target;t&&t.classList.contains("ik-corr")&&K(t)})},T=function(e){var t=e.text,n=t.match(/[a-zA-ZŻŹŁŚĆÓąęćłóśńżź]{2,}/g),i=t.match(/.{4}[,.)”–?]|[(„].{4}/g),r=[];return i&&(t=N(t,i)),e.hasOwnProperty("sugg")&&(t=j(t,e.sugg,r)),n&&(t=O(t,n)),e.hasOwnProperty("succ")&&(t=A(t,e.succ,r)),e.hasOwnProperty("fail")&&(t=H(t,e.fail)),t},N=function(e,t){for(var n=0;n<t.length;n++)-1===i.indexOf(t[n])&&-1===i.indexOf(Y(t[n].toLowerCase()))&&(e=e.replace(t[n],t[n].replace(/([,.()„”–?])/g,`<span class="ik-mark"><span data-corr="$1" class="ik-corr ik-corr-succ">$1</span><ul>${M()}</ul></span>`)),s++);return e},j=function(e,t,n){for(var i=0;i<t.length;i++){var r=t[i],a=r.length-1,o=r[a],s=o.toLowerCase(),c="";(r=r.slice(0,a)).indexOf(s)<0&&r.indexOf(o.substr(0,1).toUpperCase()+s.substr(1))<0?c="2":r=R(r,s);var l=r.length?`<li class="ik-sugg">${r.join('</li><li class="ik-sugg">')}</li>`:"";e=e.replace(q(o,"i"),`$1<span class="ik-mark"><span data-corr="$2" class="ik-corr ik-corr-sugg${c}">$2</span><ul>${l+M()}</ul></span>`),n[i]=o}return e},O=function(e,t){for(var n=0;n<t.length;n++){var r=t[n],a=q(r);i.match(a)||(e=(e=e.replace(a,`$1<span class="ik-mark"><span data-corr="$2" class="ik-corr ik-corr-succ">$2</span><ul>${M()}</ul></span>`)).replace(new RegExp(`ik-corr-sugg(2?)(?=">${r})`,"g"),"ik-corr-sugg$1-succ"),s++)}return e},A=function(e,t,n){for(var i=0;i<t.length;i++){var r=t[i][0],a=t[i][1];e=n.indexOf(a)>=0?e.replace(new RegExp(`ik-corr-sugg(?=">${r})`,"g"),"ik-corr-sugg-succ"):e.replace(new RegExp(`>${r}</span><ul>`,"g"),` data-orig="${a}">${r}</span><ul><li class="ik-act-rev">[cofnij korektę]</li>`)}return e},H=function(e,t){for(var n=0;n<t.length;n++)e=e.replace(q(t[n]),`$1<span class="ik-mark"><span data-corr="$2" class="ik-corr ik-corr-fail">$2</span><ul>${M()}</ul></span>`);return e},R=function(e,t){if(e.splice(e.indexOf(t),1),t.indexOf("rz")>-1){var n=e.indexOf(t.replace("rz","z"));n>-1&&e.splice(n,1)}return e},q=function(e,t){return new RegExp(`(\\s|[„(/,:;]|-|^)(${e})(?=\\s|[.?!,…:;"”()/<]|-|$)`,"g"+(t||""))},M=function(){return'<li class="ik-act-edit">[edytuj]</li><li class="ik-act-rest ik-dis">[przywróć]</li>'},_=function(e){var t=e.parentNode.previousSibling;e.classList.contains("ik-act-rev")?P(t,e):e.classList.contains("ik-act-edit")?I(t):e.classList.contains("ik-act-rest")?B(t,e):D(t,e)},P=function(e,t){e.textContent=e.getAttribute("data-orig"),e.classList.add("ik-corr-rev"),e.classList.remove("ik-corr-user"),t.classList.add("ik-dis"),t.parentNode.querySelector(".ik-act-rest").classList.remove("ik-dis")},I=function(e){var t=document.createRange(),n=window.getSelection();e.setAttribute("contenteditable",!0),t.setStart(e.childNodes[0],e.textContent.length),t.collapse(!0),n.removeAllRanges(),n.addRange(t)},K=function(e){var t=e.nextSibling,n=e.textContent,i=n===e.getAttribute("data-orig"),r=n===e.getAttribute("data-corr");e.setAttribute("contenteditable",!1),e.classList.toggle("ik-corr-user",!r&&!i),e.classList.toggle("ik-corr-rev",i),t.querySelector(".ik-act-rest").classList.toggle("ik-dis",r),t.querySelector(".ik-act-edit").classList.toggle("ik-dis",""===n);var a=t.querySelector(".ik-act-rev");a&&a.classList.toggle("ik-dis",!r),U(t,n),e.blur()},D=function(e,t){var n=t.textContent,i=t.parentNode;e.textContent.match(/^[A-ZŻŹŁĆŚÓ]/)&&(n=n.charAt(0).toUpperCase()+n.substr(1)),e.textContent=n,e.classList.add("ik-corr-user"),e.classList.remove("ik-corr-rev"),U(i),t.classList.add("ik-dis"),i.querySelector(".ik-act-rest").classList.remove("ik-dis"),i.querySelector(".ik-act-edit").classList.remove("ik-dis");var r=i.querySelector(".ik-act-rev");r&&r.classList.add("ik-dis")},B=function(e,t){var n=e.getAttribute("data-corr"),i=t.parentNode;e.textContent=n,e.classList.remove("ik-corr-user","ik-corr-rev"),t.classList.add("ik-dis"),U(i),i.querySelector(".ik-act-edit").classList.remove("ik-dis");var r=i.querySelector(".ik-act-rev");r&&r.classList.remove("ik-dis")},U=function(e,t=null){[].forEach.call(e.getElementsByClassName("ik-sugg"),e=>{e.classList.toggle("ik-dis",t&&t.toLowerCase()===e.textContent)})},Z=function(e){var i=G(ae("ik-txt").innerHTML);F(J(i)),n.focus(),e.style.display="none",t.disabled=!1},F=function(e){if("true"===n.contentEditable)W(e);else{var t=n.selectionStart,i=n.selectionEnd;n.value=t===i?e:n.value.substr(0,t)+V(e)+n.value.substr(i)}},W=function(e){if(n.innerHTML.match(/<\/(div|p|span)>/)&&!confirm("Zamiana spowoduje utratę dodatkowych danych określających np. wygląd tekstu. Czy kontynuować?"))return!1;a?X(e):n.innerHTML=e.replace(/\n/g,"<br>")},X=function(e){var t=V(e).split("\n");o.deleteContents();for(var n=t.length-1;n>=0;n--)o.insertNode(document.createTextNode(t[n])),n&&o.insertNode(document.createElement("br"));a.removeAllRanges()},V=function(e){return i.match(/^\s*/)+e+i.match(/\s*$/)},Y=function(e){return e.replace("ó","o").replace("ł","l").replace("ą","a").replace("ę","e").replace("ś","s").replace("ń","n").replace("ć","c").replace("ż","z").replace("ź","z")},G=function(e){return e.replace(/<ul>.*?<\/ul>|<\/?span.*?>/g,"")},J=function(e){var t={"&amp;":"&","&lt;":"<","&gt;":">","&quot;":'"',"&#039;":"'"};return e.replace(/&amp;|&lt;|&gt;|&quot;|&#039;/g,e=>t[e])},Q=function(e,t){return`<button type="button" id="${t}">${e}</button>`},ee=function(t,n,i){return`<a href="${e+t}" target="_blank" rel="noopener"${i?` id="${i}"`:""}>${n}</a>`},te=function(e){var t=e.getBoundingClientRect();return{top:t.top+window.pageYOffset-document.documentElement.clientTop,left:t.left+window.pageXOffset-document.documentElement.clientLeft}},ne=function(e){return e.toString().match(/(?:[^1]|^)[234]$/)?"znaki":"znaków"},ie=function(e){return!!(e.offsetWidth||e.offsetHeight||e.getClientRects().length)},re=function(e,t){e.style.opacity=0;let n=0;const i=setInterval(function(){(n+=50/(t||500))>=1&&(clearInterval(i),n=1),e.style.opacity=n},50)},ae=function(e){return document.getElementById(e)}};iKorektor.init(document.getElementsByTagName("textarea").length||document.querySelector("input[type=text]"));
