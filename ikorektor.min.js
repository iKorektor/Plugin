var iKorektor=new function(){var e,t,r={parags:0,profanity:0,gateway:!0,location:"bottom"},n=document.getElementById("ik-conf");n&&(r.parags=n.getAttribute("data-parags"),r.profanity=n.getAttribute("data-profanity"),r.gateway="true"===n.getAttribute("data-gateway"),r.location=n.getAttribute("data-location")),this.init=function(){document.body.insertAdjacentHTML("beforeend",'<button type="button" id="ik-do" title="Sprawdź błędy w tekście"><p></p></button>\n<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/ikorektor/plugin@1.0.0/css/style.min.css">'),document.addEventListener("mousedown",function(e){e.target&&"ik-do"===e.target.id&&o(e.target)}),document.addEventListener("click",function(e){e.target&&("li"===e.target.tagName.toLowerCase()&&e.target.parentNode.parentNode.classList.contains("ik-bgword")?w(e.target):"ik-accept"===e.target.id?h():"ik-cancel"===e.target.id?(document.getElementById("ik-inf").style.display="none",document.getElementById("ik-do").disabled=!1):"ik-legend"===e.target.id&&x(e.target))}),document.addEventListener("keydown",function(r){13===r.keyCode&&r.target&&r.target.classList.contains("ik-word-corr-origin")?m(r):90===r.keyCode&&r.ctrlKey&&t&&(e.value=t)}),document.addEventListener("focusin",function(e){if(e.target){var t=e.target.tagName.toLowerCase();("textarea"===t||"input"===t&&"text"===e.target.getAttribute("type"))&&i()}}),document.addEventListener("focusout",function(e){if(e.target&&e.target.classList.contains("ik-word-corr-origin"))m(e);else{var t=document.getElementById("ik-inf");t&&(t.offsetWidth||t.offsetHeight||t.getClientRects().length)||(document.getElementById("ik-do").style.display="none")}})};var i=function(){e=document.activeElement;var t=document.getElementById("ik-do"),n=document.getElementById("ik-inf");t.style.display="block";var i=E(e),o="top"===r.location?i.top+5:i.top+e.offsetHeight-t.offsetHeight-5,a=window.innerWidth-(i.left+e.offsetWidth);t.style.top=o.toFixed(2)+"px",t.style.right=a.toFixed(2)+"px",t.disabled=!1,n&&(n.style.display="none")},o=function(e){var t=c();t.length<3?l("Tekst jest zbyt krótki.",!0):(e.disabled=!0,e.querySelector("p").classList.add("ik-spin"),a(t))},a=function(e){fetch("https://api.ikorektor.pl",{method:"POST",body:s(e)}).then(e=>{if(e.ok)return e.json();throw Error(e.statusText)}).then(r=>{if(r.hasOwnProperty("error"))l(g(r,e.length),!0);else{t=e;var n=document.createElement("p");n.textContent=r.text,r.text=n.innerHTML,l(k(r),!1)}}).catch(e=>{console.log(e),l("Wystąpił nieoczekiwany błąd. Być może straciłeś połączenie z Internetem lub plugin jest niepoprawnie skonfigurowany na stronie.",!0)})},s=function(e){var t=new FormData;return t.append("key","O"),t.append("text",e),t.append("app","plugin"),r.parags&&t.append("parags",r.parags),r.profanity&&t.append("profanity",r.profanity),r.gateway||t.append("gateway",r.gateway),t},c=function(){var t=e.selectionStart,r=e.selectionEnd;return t===r?e.value.trim():e.value.slice(t,r)},l=function(e,t){var r=document.getElementById("ik-inf");r||(r=d());var n=document.getElementById("ik-do"),i=r.querySelector("div").querySelector("p"),o=r.querySelector("#ik-accept"),a=E(n);n.disabled=!t,n.querySelector("p").classList.remove("ik-spin"),r.style.top=a.top+n.offsetHeight+9+"px",r.style.right=n.ownerDocument.defaultView.getComputedStyle(n,null).right,r.style.display="block",i.innerHTML=e,i.classList.toggle("ik-corr-err",t),o.disabled=t,o.classList.toggle("ik-btn-disabled",t),p()},d=function(){return document.body.insertAdjacentHTML("beforeend",'<div id="ik-inf">\n<div><p></p><p><a href="https://ikorektor.pl/pluginy" target="_blank">Plugin autokorekty – iKorektor</a><span id="ik-legend">i</span></p></div>\n<ul id="ik-colors"></ul>\n<button type="button" id="ik-accept">Akceptuj i zamień</button>\n<button type="button" id="ik-cancel">Anuluj</button>\n</div>'),document.getElementById("ik-inf")},u=function(e){return t.match(/^\s*/)+e+t.match(/\s*$/)},g=function(e,t){switch(e.error){case"TXT_LEN":return`Tekst jest zbyt długi (${t} na ${e.txt_limit} dozwolonych znaków w jednej korekcie).`;case"CHARS_LMT":return`Możesz sprawdzić dzisiaj jeszcze ${e.chars_left} znaków, tekst ma ${t} znaków.`;case"CALLS_LMT":return"Osiągnięto limit korekt na minutę. Spróbuj ponownie za chwilę.";case"CALLS_LMT_SITE":return"Osiągnięto dobowy limit użycia pluginu."}return"Wystąpił nieoczekiwany błąd."},p=function(){[].forEach.call(document.getElementsByClassName("ik-bgword"),e=>{e.classList.contains("ik-char-succ")||e.querySelector("ul").insertAdjacentHTML("beforeend",'<li class="ik-act-user ik-act-edit">[edytuj]</li><li class="ik-act-user ik-act-restore ik-hidden">[przywróć]</li>')})},k=function(e){var r=e.text,n=r.match(/[a-zA-ZŻŹŁŚĆÓąęćłóśńżź]{2,}/g),i=r.match(/.{4}[,.)”–?]|[(„].{4}/g),o=[],a=null;if(i)for(var s=0;s<i.length;s++)-1===t.indexOf(i[s])&&-1===t.indexOf(v(i[s].toLowerCase()))&&(r=r.replace(i[s],i[s].replace(/([,.()„”–?])/g,'<span class="ik-bgword ik-corr-succ ik-char-succ">$1</span>')));if(e.hasOwnProperty("sugg"))for(s=0;s<e.sugg.length;s++){var c=e.sugg[s],l=c.length-1,d=(g=c[l]).toLowerCase(),u="";(c=c.slice(0,l)).indexOf(d)<0&&c.indexOf(g.substr(0,1).toUpperCase()+d.substr(1))<0?u="2":c=y(c,d),r=r.replace(f(g,"i"),'$1<span class="ik-bgword ik-corr-sugg'+u+'"><span data-word-corr-origin="$2" class="ik-word-corr-origin">$2</span><ul><li>'+c.reverse().join("</li><li>")+"</li></ul></span>"),o.push(g)}if(n)for(s=0;s<n.length;s++){var g=n[s];if(a=f(g),!t.match(a)){r=r.replace(a,'$1<span class="ik-bgword ik-corr-succ"><span data-word-corr-origin="$2" class="ik-word-corr-origin">$2</span><ul></ul></span>');var p=new RegExp('ik-corr-sugg(2?)(?="><span data-word-corr-origin="'+g+")","g");r=r.replace(p,"ik-corr-sugg$1-succ")}}if(e.hasOwnProperty("succ"))for(s=0;s<e.succ.length;s++){var k=e.succ[s][0],m=e.succ[s][1];o.indexOf(m)>=0?(a=new RegExp('ik-corr-sugg(?="><span data-word-corr-origin="'+k+")","g"),r=r.replace(a,"ik-corr-sugg-succ")):(a=new RegExp(">"+k+"</span><ul></ul>","g"),r=r.replace(a,'data-word-origin="'+m+'">'+k+'</span><ul><li class="ik-act-user ik-act-revert">[cofnij]</li></ul>'))}if(e.hasOwnProperty("fail"))for(s=0;s<e.fail.length;s++)r=r.replace(f(e.fail[s]),'$1<span class="ik-bgword ik-corr-fail"><span data-word-corr-origin="$2" class="ik-word-corr-origin">$2</span><ul>Nierozpoznany błąd</ul></span>');return r},f=function(e,t){return new RegExp("(\\s|[„(/,:;]|-|^)("+e+')(?=\\s|[.?!,…:;"”()/<]|-|$)',"g"+(t||""))},y=function(e,t){if(e.splice(e.indexOf(t),1),t.indexOf("rz")>-1){var r=e.indexOf(t.replace("rz","z"));r>-1&&e.splice(r,1)}return e},m=function(e){var t=e.target,r=t.nextElementSibling,n=t.textContent,i=n===t.getAttribute("data-word-origin"),o=n===t.getAttribute("data-word-corr-origin");t.setAttribute("contenteditable","false"),t.classList.toggle("ik-corr-user",!o&&!i),t.classList.toggle("ik-corr-revert",i),r.querySelector(".ik-act-restore").classList.toggle("ik-hidden",o),r.querySelector(".ik-act-edit").classList.toggle("ik-hidden",""===n);var a=r.querySelector(".ik-act-revert");a&&a.classList.toggle("ik-hidden",i)},w=function(e){var t=e.parentNode.parentNode.querySelector(".ik-word-corr-origin");e.classList.contains("ik-act-revert")?function(e,t){e.textContent=e.getAttribute("data-word-origin"),e.classList.add("ik-corr-revert"),e.classList.remove("ik-corr-user"),t.style.display="none",t.parentNode.querySelector(".ik-act-restore").classList.remove("ik-hidden")}(t,e):e.classList.contains("ik-act-edit")?function(e){var t=document.createRange(),r=window.getSelection();e.setAttribute("contenteditable","true"),t.setStart(e.childNodes[0],e.textContent.length),t.collapse(!0),r.removeAllRanges(),r.addRange(t)}(t):e.classList.contains("ik-act-restore")?function(e,t){var r=e.getAttribute("data-word-corr-origin");e.textContent=r,e.classList.remove("ik-corr-user","ik-corr-revert"),t.classList.add("ik-hidden"),t.parentNode.querySelector(".ik-act-edit").style.display="block";var n=t.parentNode.querySelector(".ik-act-revert");n&&(n.style.display="block")}(t,e):function(e,t){var r=t.textContent;e.textContent.match(/^[A-ZŻŹŁĆŚÓ]/)&&(r=r.charAt(0).toUpperCase()+r.substr(1)),e.textContent=r,e.classList.toggle("ik-corr-user",r!==e.getAttribute("data-word-corr-origin")),t.parentNode.querySelector(".ik-act-restore").classList.remove("ik-hidden")}(t,e)},h=function(){var t=document.getElementById("ik-inf").querySelector("div").querySelector("p").innerHTML,r=b(t);!function(t){var r=e.selectionStart,n=e.selectionEnd;e.value=r===n?t:e.value.substr(0,r)+u(t)+e.value.substr(n)}(L(r)),e.focus()},v=function(e){return e.replace("ó","o").replace("ł","l").replace("ą","a").replace("ę","e").replace("ś","s").replace("ń","n").replace("ć","c").replace("ż","z").replace("ź","z")},b=function(e){return e.replace(/<ul>.*?<\/ul>|<\/?span.*?>/g,"")},L=function(e){var t={"&amp;":"&","&lt;":"<","&gt;":">","&quot;":'"',"&#039;":"'"};return e.replace(/&amp;|&lt;|&gt;|&quot;|&#039;/g,e=>t[e])},x=function(e){var t=document.getElementById("ik-colors");if(""!==t.innerHTML||e.classList.contains("ik-spin"))S(t);else{var r=function(r){t.innerHTML=r,S(t),e.classList.remove("ik-spin")};e.classList.add("ik-spin"),fetch("https://ikorektor.pl/corr_info").then(e=>{if(e.ok)return e.text();throw Error(e.statusText)}).then(e=>{r(e)}).catch(e=>{r(e)})}},E=function(e){const t=e.getBoundingClientRect();return{top:t.top+window.pageYOffset-document.documentElement.clientTop,left:t.left+window.pageXOffset-document.documentElement.clientLeft}},S=function(e){e.style.transition="max-height 1s";const{height:t}=e.ownerDocument.defaultView.getComputedStyle(e,null);e.style["max-height"]=(0===parseInt(t,10)?500:0)+"px"}};iKorektor.init();
